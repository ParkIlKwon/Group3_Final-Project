<!--휴가결재 작성 양식-->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>휴가 신청기안</title>
</head>
<body>
<div>
    <form id="q" action="/test" method="POST">
        <input type="hidden" name="memberId" th:value="${hrGuy.id}">
        <div class="form-group" th:object="${boardApprovalDTO}">
            <div class="form-group">
                <label th:for="boardContent">휴가 신청 사유</label>
                <textarea th:field="*{boardContent}" placeholder="사유를 입력하다."></textarea>
            </div>
        </div>

        <div class="form-group" th:object="${boardApprovalInfoDTO}">
            <div class="form-group">
                <label th:for="startDate">휴가 시작일</label>
                <input type="date" th:field="*{startDate}" placeholder="시작일을 입력하다.">
            </div>
            <div class="form-group">
                <label th:for="endDate">휴가 복귀일</label>
                <input type="date" th:field="*{endDate}" placeholder="복귀일을 입력하다.">
            </div>
            <div class="form-group">
                <label th:for="deduction">연차 차감 시간</label>
                <input type="number" id="deduction" th:field="*{deduction}" placeholder="연차 차감 시간" readonly>
            </div>
        </div>
<!--        <input type="submit" onclick="submitForm()">제출</input>-->
        <button onclick="submitForm()">제출
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let parentWindow = window.opener;
    console.log(parentWindow)

    let startDateInput=document.querySelector('input[name="startDate"]');
    let endDateInput=document.querySelector('input[name="endDate"]');
    let deductionInput=document.querySelector('input[name="deduction"]');

    // endDate 입력 폼을 비활성화하다.
    endDateInput.disabled=true;

    // startDate 입력 폼의 최소 날짜를 현재 날짜로 설정해주다.
    let today=new Date();
    startDateInput.min=today.toISOString().split('T')[0];

    // startDate 입력 폼의 값이 변경될 때마다 endDate 입력 폼의 최소 날짜를 startDate 값으로 설정해주다.
    startDateInput.addEventListener('change', function() {
        endDateInput.min=startDateInput.value;

        // endDate 입력 폼을 활성화하다.
        endDateInput.disabled=false;

        // startDate와 endDate를 비교하여 endDate가 startDate보다 작은 경우, endDate 값을 startDate와 동일하게 설정하다.
        if(new Date(endDateInput.value) < new Date(startDateInput.value)) {
            endDateInput.value=startDateInput.value;
        }

        // startDate와 endDate 사이의 일수를 계산하여 차감일수(deduction)를 보여주다.
        let diffDays=calculateDays(startDateInput, endDateInput);
        let deductionDays=diffDays * 8;
        if(diffDays===0) {
            deductionDays=4;
        }
        deductionInput.value=deductionDays;
    });

    // endDate 입력 폼의 값이 변경될 때마다, 차감일수(deduction)를 자동으로 계산하여 할당해주다.
    endDateInput.addEventListener('change', function() {
        let diffDays=calculateDays(startDateInput, endDateInput);
        let deductionDays=diffDays*8;
        if(diffDays===0) {
            deductionDays=4;
        }
        deductionInput.value=deductionDays;
    });

    // endDate 입력 폼의 값이 변경될 때마다, 차감일수(deduction)를 자동으로 계산하여 할당다.
    endDateInput.addEventListener('input', function() {
        let diffDays=calculateDays(startDateInput, endDateInput);
        let deductionDays=diffDays*8;
        if (diffDays===0) {
            deductionDays=4;
        }
        deductionInput.value=deductionDays;
    });

    // startDate와 endDate 사이의 일수를 계산하는 함수
    function calculateDays(startDateInput, endDateInput) {
        let startDate=new Date(startDateInput.value);
        let endDate=new Date(endDateInput.value);
        let diffMs=endDate.getTime()-startDate.getTime();
        let diffDays=diffMs/(1000*60*60*24);
        diffDays=Math.round(diffDays);

        return diffDays;
    }




    function submitForm() {
        // form submit
        // document.getElementById("#q").submit();

        // 부모창에 대한 참조 가져오기
        // const parentWindow = window.opener;
        //
        // // 부모창이 존재하는 경우
        // if (parentWindow) {
        //     // 부모창의 함수 호출
        //     parentWindow.onChildWindowClose();
        //
        //     // 자식창 닫기
        //     window.close();
        // }
        //let formData=document.getElementById("#q").serialize();
        let deduction = $("#deduction").val();
        $.ajax({
            url: "/board/newapprovalvacationboard",
            type: "Post",
            data:{"deduction" : deduction},
            success: function (data) {
                console.log("tst1");
                alert("data=" + data);
                self.close();
                opener.location.reload();

                // window.close();
                // if (data === "success") {
                //     alert("성공하다.");s
                //     // 데이터 처리가 완료되면 창을 닫고 부모 창을 다시 로드합니다.
                //     window.close();
                //     window.opener.location.reload();
                // } else {
                //     alert("처리 도중 오류가 발생했습니다.");
                // }
            },
            error:function(request,status,error){
                alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                self.close();
            }
        }).done(function () {
                console.log("tst2")
            }
        );
    }


  //   $(document).ready(function() {
  //
  //       $('#vacationForm').submit(function(e) {
  //           e.preventDefault();
  //
  //       var formData = document.getElementById("#q").serialize();
  //       alert(formData)
  //       $.ajax({
  //           url: "/test",
  //           type: "Post",
  //           data : formData,
  //           success: function (data) {
  //               console.log("tst1")
  //               alert("data=" + data);
  //               self.close();
  //               // window.close();
  //               // if (data === "success") {
  //               //     alert("성공하다.");
  //               //     // 데이터 처리가 완료되면 창을 닫고 부모 창을 다시 로드합니다.
  //               //     window.close();
  //               //     window.opener.location.reload();
  //               // } else {
  //               //     alert("처리 도중 오류가 발생했습니다.");
  //               // }
  //           },
  //           error:function(request,status,error){
  //               alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
  //           }
  //       }).done(function () {
  //               console.log("tst2")
  //               window.close();
  //           }
  //       );
  //
  // });
  //  });










    // const form = document.getElementById('board-approval-form');
    // $(document).ready(function() {
    //     $("form").submit(function(event) {
    //         event.preventDefault(); // 기본적인 submit 이벤트 동작을 막음
    //         var form = $(this);
    //         var url = form.attr("action");
    //         var method = form.attr("method");
    //         $.ajax({
    //             url: url,
    //             type: method,
    //             data: form.serialize(),
    //             success: function() {
    //                 // 부모창(main.html)을 이동시킴
    //                 window.opener.location.href = "/moveApproval";
    //                 window.close(); // 현재 창(appvacation.html)을 닫음
    //             },
    //             error: function() {
    //                 alert("Error submitting form");
    //             }
    //         });
    //     });
    // });

</script>

<style>
    body {
        font-family: 'Noto Sans KR', sans-serif;
        background-color: #f5f5f5;
        color: #333;
        margin: 0;
        padding: 0;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .container {
        width: 90%;
        background-color: #fff;
        padding: 40px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-height: 90%;
        overflow-y: auto;
    }
    .form-group {
        margin-bottom: 20px;
    }
    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    input, textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 14px;
        color: #333;
        resize: none;
    }
    textarea {
        height: 100px;
        max-width: 100%;
    }
    button {
        width: 100%;
        padding: 12px;
        background-color: #007BFF;
        border: none;
        border-radius: 3px;
        color: #fff;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    button:hover {
        background-color: #0056b3;
    }
</style>

</body>
</html>